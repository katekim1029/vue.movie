<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Step 1. Vanilla Js</title>
<link  rel="stylesheet" href="https://fonts.googleapis.com/css?family=Do+Hyeon|Sunflower:300">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="./style.css">
</head>
<body>

<div class="container">

    <header class="header">
        <h1 class="title">오늘의 영화</h1>
    </header>

    <nav class="menu" id="menuBox">
        <ul class="list-menu">
            <li class="on">
                <a href="#listBox">검색하기</a>
            </li>
            <li>
                <a href="#favorBox">즐겨찾기</a>
            </li>
        </ul>
    </nav>

    <div class="content">
        <div class="cont" id="listBox" style="display:block;">
            <div class="search" id="searchForm">
                <input type="date" placeholder="날짜를 선택하세요" class="inp-date">
            </div>
            <div id="movieList"></div>
        </div>
        <div class="cont" id="viewBox">

        </div>
        <div class="cont" id="favorBox">

        </div>
    </div>

</div>


<script src="https://npmcdn.com/axios/dist/axios.min.js"></script>
<script type="module" src="./js/app.js"></script>
<!-- script>
const menuBox = document.querySelector("#menuBox");
const listBox = document.querySelector("#listBox");
const viewBox = document.querySelector("#viewBox");
const favorBox = document.querySelector("#favorBox");
const dateElem = listBox.querySelector("#targetDate");
let isResolved = true;
function showBox(el) {
    listBox.style.display = 'none';
    viewBox.style.display = 'none';
    favorBox.style.display = 'none';
    el.style.display = 'block';
}
function getToday() {
    const todayDate = new Date().toISOString().slice(0,10);
    return todayDate;
}
document.addEventListener('DOMContentLoaded', () => {
    showBox(listBox);
    addEvents();
});
function addEvents() {
    const todayDate = getToday();
    let pageIndex = 0;
    dateElem.setAttribute('max', todayDate);
    dateElem.addEventListener('change', e => {
        let targetDate = e.target.value;
        targetDate = targetDate.split('-').join('');
        updateListData(targetDate);
    });
    Array.from(menuBox.querySelectorAll('a')).forEach(link => {
        link.addEventListener('click', function(e) {
            let pageBox = document.querySelector(e.target.getAttribute("href"));
            e.preventDefault();
            showBox(pageBox);
            menuBox.querySelectorAll('li')[pageIndex].classList.remove('on');
            this.parentElement.classList.add('on');
            if(pageBox === favorBox) {
                pageIndex = 1;
                updateFavorHtml();
            }
            else {
                pageIndex = 0;
            }
        });
    });
}
function updateListData(targetDate) {
    const key = "06f5b3df94419d30ccbc9a117c93d95b";
    const host = "http://www.kobis.or.kr";
    const daily = "/kobisopenapi/webservice/rest/boxoffice/searchDailyBoxOfficeList.json";
    const param = {
        "key" : key,
        "targetDt" : targetDate
    };
    axios.get(host + daily, {
        params: param
    })
    .then( response => {
        updateListHtml(response.data);
    } );
    //.catch( response => { console.log(response) } );
}
function updateListHtml(data) {
    const listElem = document.querySelector("#movieList");
    const result = data.boxOfficeResult.dailyBoxOfficeList;
    let html = "";
    html += "<ul class='list-movie'>"
    for (let key in result) {
        html += `<li><a href="#" data-key="${ result[key].movieCd }">
            <i>${ result[key].rank } /</i>
            ${ result[key].movieNm }
        </a></li>`
    }
    html += "</ul>";
    showBox(listBox);
    listElem.innerHTML = html;
    Array.from(listElem.querySelectorAll('a')).forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            updateViewData(this.dataset.key);
        });
    });
}
function updateViewData(targetKey) {
    const key = "06f5b3df94419d30ccbc9a117c93d95b";
    const host = "http://www.kobis.or.kr";
    const info = "/kobisopenapi/webservice/rest/movie/searchMovieInfo.json";
    const param = {
        "key" : key,
        "movieCd" : targetKey
    };
    if(!isResolved) { return; }
    isResolved = false;
    axios.get(host + info, {
        params: param
    })
    .then( response => {
        isResolved = true;
        updateViewHtml(response.data);
    } );
    //.catch( response => { console.log(response) } );
}
function updateViewHtml(data) {
    const result = data.movieInfoResult.movieInfo;
    const actorList = (result.actors.map(a => a.peopleNm)).join(' / ');
    const docFrag = document.createDocumentFragment();
    const wrapBtn = document.createElement('div');
    const favorBtn = document.createElement('button');
    let html = "";
    html += "<dl class='detail-movie'>"
    html += `
            <dt>영화제목</dt>
            <dd>${ result.movieNm } </dd>
            <dd>${ result.movieNmEn }</dd>
            <dt>개봉연도</dt>
            <dd>${ result.openDt }</dd>
            <dt>상영시간</dt>
            <dd>${ result.showTm }</dd>
            <dt>제작국가</dt>
            <dd>${ result.nations[0].nationNm }</dd>
            <dt>감독</dt>
            <dd>${ result.directors[0].peopleNm }</dd>
            <dt>배우들</dt>
            <dd>${ actorList }</dd>
            `;
    html += "</dl>";
    showBox(viewBox);
    viewBox.innerHTML = html;
    wrapBtn.classList.add('btn-set');
    favorBtn.classList.add('btn-add');
    favorBtn.innerHTML = "즐겨찾기 추가";
    wrapBtn.appendChild(favorBtn);
    viewBox.appendChild(wrapBtn);
    favorBtn.addEventListener('click', e => {
        const movieInfo = { movieCd: result.movieCd, movieNm: result.movieNm };
        addFavorData(result.movieCd, movieInfo);
    });
}
function updateFavorHtml() {
    const wrapBtn = document.createElement('div');
    const favorBtn = document.createElement('button');
    let html = "";
    if(localStorage.length > 0) {
    html += "<ul class='list-favor'>";
    Object.keys(localStorage).forEach(key => {
        let result = JSON.parse(localStorage.getItem(key));
        html += `<li data-key="${ result.movieCd }"><button type="button" class="btn-delete"><i class="fas fa-minus-circle fa-lg"></i></button>
        <a href="#">
            ${ result.movieNm }
        </a></li>`;
    });
    html += "</ul>";
    }
    showBox(favorBox);
    favorBox.innerHTML = html;
    wrapBtn.classList.add('btn-set');
    favorBtn.classList.add('btn-clear');
    favorBtn.innerHTML = "즐겨찾기 모두 삭제";
    wrapBtn.appendChild(favorBtn);
    favorBox.appendChild(wrapBtn);
    Array.from(favorBox.querySelectorAll('a')).forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            updateViewData(this.parentElement.dataset.key);
        });
    });
    Array.from(favorBox.querySelectorAll('.btn-delete')).forEach(link => {
        link.addEventListener('click', function(e) {
            deleteFavorData(this.parentElement.dataset.key);
        });
    });
    favorBtn.addEventListener('click', e => {
        clearFavorData();
    });
}
function addFavorData(key, data) {
    localStorage.setItem(key, JSON.stringify(data));
    alert("추가되었습니다!");
}
function deleteFavorData(key) {
    localStorage.removeItem(key);
    alert("삭제되었습니다!");
    updateFavorHtml();
}
function clearFavorData() {
    localStorage.clear();
    alert("모두 삭제되었습니다!");
    updateFavorHtml();
}
</script -->
</body>
</html>
